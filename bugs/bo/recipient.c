/* Generated by CIL v. 1.7.3 */
/* print_CIL_Input is false */

#line 212 "/usr/lib/gcc/x86_64-linux-gnu/4.6/include/stddef.h"
typedef unsigned long size_t;
#line 34 "/usr/include/x86_64-linux-gnu/bits/types.h"
typedef unsigned long __u_long;
#line 135 "/usr/include/x86_64-linux-gnu/bits/types.h"
typedef unsigned int __uid_t;
#line 136 "/usr/include/x86_64-linux-gnu/bits/types.h"
typedef unsigned int __gid_t;
#line 149 "/usr/include/x86_64-linux-gnu/bits/types.h"
typedef long __time_t;
#line 39 "/usr/include/pwd.h"
typedef __gid_t gid_t;
#line 44 "/usr/include/pwd.h"
typedef __uid_t uid_t;
#line 50 "/usr/include/pwd.h"
struct passwd {
   char *pw_name ;
   char *pw_passwd ;
   __uid_t pw_uid ;
   __gid_t pw_gid ;
   char *pw_gecos ;
   char *pw_dir ;
   char *pw_shell ;
};
#line 37 "/usr/include/x86_64-linux-gnu/sys/types.h"
typedef __u_long u_long;
#line 76 "/usr/include/time.h"
typedef __time_t time_t;
#line 77 "sendmail-bad.h"
struct address {
   char *q_paddr ;
   char *q_user ;
   char *q_ruser ;
   char *q_host ;
   u_long q_flags ;
   uid_t q_uid ;
   gid_t q_gid ;
   char *q_home ;
   char *q_fullname ;
   struct address *q_next ;
   struct address *q_alias ;
   char *q_owner ;
   struct address *q_tchain ;
   char *q_orcpt ;
   char *q_status ;
   char *q_rstatus ;
   time_t q_statdate ;
   char *q_statmta ;
   short q_specificity ;
};
#line 100 "sendmail-bad.h"
typedef struct address ADDRESS;
#line 76 "recipient-bad.c"
enum bool {
    false = 0,
    true = 1
} ;
#line 127 "/usr/include/ctype.h"
extern  __attribute__((__nothrow__)) int ( __attribute__((__leaf__)) toupper)(int __c ) ;
#line 362 "/usr/include/stdio.h"
extern int printf(char const   * __restrict  __format  , ...) ;
#line 846
extern void perror(char const   *__s ) ;
#line 129 "/usr/include/string.h"
extern  __attribute__((__nothrow__)) char *( __attribute__((__nonnull__(1,2), __leaf__)) strcpy)(char * __restrict  __dest ,
                                                                                                 char const   * __restrict  __src ) ;
#line 399
extern  __attribute__((__nothrow__)) size_t ( __attribute__((__nonnull__(1), __leaf__)) strlen)(char const   *__s )  __attribute__((__pure__)) ;
#line 466 "/usr/include/stdlib.h"
extern  __attribute__((__nothrow__)) void *( __attribute__((__leaf__)) malloc)(size_t __size )  __attribute__((__malloc__)) ;
#line 72 "sendmail-bad.h"
char *xalloc(int sz ) ;
#line 73
void buildfname(char *gecos , char *login , char *buf ) ;
#line 88 "util-bad.c"
char *xalloc(int sz ) 
{ 
  register char *p ;
  void *tmp ;
  char *__cil_tmp4 ;

  {
#line 95
  if (sz <= 0) {
#line 96
    sz = 1;
  }
  {
#line 98
  tmp = malloc((size_t )((unsigned int )sz));
#line 98
  p = (char *)tmp;
  }
#line 99
  if ((unsigned long )p == (unsigned long )((void *)0)) {
    {
#line 101
    perror("Out of memory!!");
    }
  }
#line 103
  return (p);
}
}
#line 143 "util-bad.c"
void buildfname(char *gecos , char *login , char *buf ) 
{ 
  register char *p ;
  register char *bp ;
  int l ;
  size_t tmp ;
  size_t tmp___0 ;
  size_t tmp___1 ;
  int tmp___2 ;
  char *tmp___3 ;
  size_t tmp___4 ;
  char *__cil_tmp13 ;
  char *__cil_tmp14 ;
  char *__cil_tmp15 ;
  char *__cil_tmp16 ;

  {
#line 150
  bp = buf;
#line 153
  if ((int )*gecos == 42) {
#line 154
    gecos ++;
  }
#line 157
  l = 0;
#line 158
  p = gecos;
  {
#line 158
  while (1) {
    while_continue: /* CIL Label */ ;
#line 158
    if ((int )*p != 0) {
#line 158
      if ((int )*p != 44) {
#line 158
        if ((int )*p != 59) {
#line 158
          if (! ((int )*p != 37)) {
#line 158
            goto while_break;
          }
        } else {
#line 158
          goto while_break;
        }
      } else {
#line 158
        goto while_break;
      }
    } else {
#line 158
      goto while_break;
    }
#line 160
    if ((int )*p == 38) {
      {
#line 161
      tmp = strlen((char const   *)login);
#line 161
      l = (int )((size_t )l + tmp);
      }
    } else {
#line 163
      l ++;
    }
#line 158
    p ++;
  }
  while_break: /* CIL Label */ ;
  }
#line 167
  p = gecos;
  {
#line 167
  while (1) {
    while_continue___0: /* CIL Label */ ;
#line 167
    if ((int )*p != 0) {
#line 167
      if ((int )*p != 44) {
#line 167
        if ((int )*p != 59) {
#line 167
          if (! ((int )*p != 37)) {
#line 167
            goto while_break___0;
          }
        } else {
#line 167
          goto while_break___0;
        }
      } else {
#line 167
        goto while_break___0;
      }
    } else {
#line 167
      goto while_break___0;
    }
#line 169
    if ((int )*p == 38) {
      {
#line 172
      printf((char const   */* __restrict  */)"strcpy(bp,login)\n");
#line 173
      tmp___0 = strlen((char const   *)login);
#line 173
      tmp___1 = strlen((char const   *)bp);
#line 173
      printf((char const   */* __restrict  */)"strlen(bp) = %d strlen(login) = %d\n",
             tmp___1, tmp___0);
#line 176
      strcpy((char */* __restrict  */)bp, (char const   */* __restrict  */)login);    // ZOO_BUG
#line 177
      tmp___2 = toupper((int )*bp);
#line 177
      *bp = (char )tmp___2;
      }
      {
#line 178
      while (1) {
        while_continue___1: /* CIL Label */ ;
#line 178
        if (! ((int )*bp != 0)) {
#line 178
          goto while_break___1;
        }
#line 179
        bp ++;
      }
      while_break___1: /* CIL Label */ ;
      }
    } else {
      {
#line 183
      tmp___3 = bp;
#line 183
      bp ++;
#line 183
      *tmp___3 = *p;        // ZOO_BUG
#line 184
      printf((char const   */* __restrict  */)"bp-buf = %d\n", bp - buf);
      }
    }
#line 167
    p ++;
  }
  while_break___0: /* CIL Label */ ;
  }
  {
#line 187
  *bp = (char )'\000';
#line 189
  tmp___4 = strlen((char const   *)buf);
#line 189
  printf((char const   */* __restrict  */)"buf can store at most %d bytes; strlen(buf) = %d\n",
         5, tmp___4);
  }
#line 190
  return;
}
}
#line 73 "/usr/include/pwd.h"
extern void setpwent(void) ;
#line 85
extern struct passwd *getpwent(void) ;
#line 117
extern struct passwd *getpwnam(char const   *__name ) ;
#line 488 "/usr/include/stdlib.h"
extern  __attribute__((__nothrow__)) void ( __attribute__((__leaf__)) free)(void *__ptr ) ;
#line 143 "/usr/include/string.h"
extern  __attribute__((__nothrow__)) int ( __attribute__((__nonnull__(1,2), __leaf__)) strcmp)(char const   *__s1 ,
                                                                                               char const   *__s2 )  __attribute__((__pure__)) ;
#line 235
extern  __attribute__((__nothrow__)) char *( __attribute__((__nonnull__(1), __leaf__)) strchr)(char const   *__s ,
                                                                                               int __c )  __attribute__((__pure__)) ;
#line 536
extern  __attribute__((__nothrow__)) int ( __attribute__((__nonnull__(1,2), __leaf__)) strcasecmp)(char const   *__s1 ,
                                                                                                   char const   *__s2 )  __attribute__((__pure__)) ;
#line 81 "/usr/include/ctype.h"
extern  __attribute__((__nothrow__)) unsigned short const   **( __attribute__((__leaf__)) __ctype_b_loc)(void)  __attribute__((__const__)) ;
#line 126
extern  __attribute__((__nothrow__)) int ( __attribute__((__leaf__)) tolower)(int __c ) ;
#line 71 "sendmail-bad.h"
int MaxAliasRecursion ;
#line 102
ADDRESS *recipient(ADDRESS *a , ADDRESS **sendq , int aliaslevel ) ;
#line 77 "recipient-bad.c"
enum bool MatchGecos  =    (enum bool )1;
#line 78 "recipient-bad.c"
char SpaceSub  =    (char )' ';
#line 79 "recipient-bad.c"
int MaxAliasRecursion  =    0;
#line 155
struct passwd *finduser(char *name , enum bool *fuzzyp ) ;
#line 104 "recipient-bad.c"
ADDRESS *recipient(ADDRESS *a , ADDRESS **sendq , int aliaslevel ) 
{ 
  register char *p ;
  enum bool quoted ;
  int i ;
  char *buf ;
  char buf0[5] ;
  size_t tmp ;
  enum bool fuzzy ;
  register struct passwd *pw ;
  char test_buf[10] ;
  char nbuf[5] ;
  size_t tmp___0 ;
  char *tmp___1 ;
  int tmp___2 ;
  size_t tmp___3 ;
  char *tmp___4 ;
  size_t tmp___5 ;
  char *tmp___6 ;
  void *__cil_tmp21 ;
  void *__cil_tmp22 ;
  void *__cil_tmp23 ;
  char *__cil_tmp24 ;
  char *__cil_tmp25 ;
  char *__cil_tmp26 ;
  char *__cil_tmp27 ;
  char *__cil_tmp28 ;
  char *__cil_tmp29 ;
  char *__cil_tmp30 ;
  char *__cil_tmp31 ;
  char *__cil_tmp32 ;
  char *__cil_tmp33 ;
  char *__cil_tmp34 ;
  char *__cil_tmp35 ;
  char *__cil_tmp36 ;

  {
#line 112
  quoted = (enum bool )0;
#line 118
  if (aliaslevel == 0) {
#line 119
    a->q_flags |= 8UL;
  }
#line 123
  if (aliaslevel > MaxAliasRecursion) {
    {
#line 125
    a->q_status = (char *)"5.4.6";
#line 126
    printf((char const   */* __restrict  */)"554 aliasing/forwarding loop broken (%d aliases deep; %d max",
           aliaslevel, MaxAliasRecursion);
    }
#line 128
    return (a);
  }
  {
#line 136
  tmp = strlen((char const   *)a->q_user);
#line 136
  i = (int )tmp;
  }
#line 137
  if ((unsigned long )i >= sizeof(buf0)) {
    {
#line 138
    buf = xalloc(i + 1);
    }
  } else {
#line 140
    buf = buf0;
  }
  {
#line 141
  strcpy((char */* __restrict  */)buf, (char const   */* __restrict  */)a->q_user);
#line 143
  p = buf;
  }
  {
#line 143
  while (1) {
    while_continue: /* CIL Label */ ;
#line 143
    if ((int )*p != 0) {
#line 143
      if (! (! quoted)) {
#line 143
        goto while_break;
      }
    } else {
#line 143
      goto while_break;
    }
#line 145
    if ((int )*p == 92) {
#line 146
      quoted = (enum bool )1;
    }
#line 143
    p ++;
  }
  while_break: /* CIL Label */ ;
  }
  {
#line 157
  printf((char const   */* __restrict  */)"Inside TRUE block!!\n");
#line 160
  printf((char const   */* __restrict  */)"buf used in finduser = %s\n", buf);
#line 161
  pw = finduser(buf, & fuzzy);
  }
#line 162
  if ((unsigned long )pw == (unsigned long )((void *)0)) {
    {
#line 164
    printf((char const   */* __restrict  */)"Name was not found!\n");
#line 165
    a->q_flags |= 2UL;
#line 166
    a->q_status = (char *)"5.1.1";
    }
  } else {
    {
#line 173
    strcpy((char */* __restrict  */)(test_buf), (char const   */* __restrict  */)"GOOD");
#line 174
    tmp___2 = strcmp((char const   *)pw->pw_dir, "/");
    }
#line 174
    if (tmp___2 == 0) {
#line 175
      a->q_home = (char *)"";
    } else {
      {
#line 177
      tmp___0 = strlen((char const   *)pw->pw_dir);
#line 177
      tmp___1 = xalloc((int )(tmp___0 + 1UL));
#line 177
      a->q_home = strcpy((char */* __restrict  */)tmp___1, (char const   */* __restrict  */)pw->pw_dir);
      }
    }
    {
#line 178
    a->q_uid = pw->pw_uid;
#line 179
    a->q_gid = pw->pw_gid;
#line 180
    tmp___3 = strlen((char const   *)pw->pw_name);
#line 180
    tmp___4 = xalloc((int )(tmp___3 + 1UL));
#line 180
    a->q_ruser = strcpy((char */* __restrict  */)tmp___4, (char const   */* __restrict  */)pw->pw_name);
#line 181
    a->q_flags |= 4UL;
#line 183
    printf((char const   */* __restrict  */)"Before call to builfname, pw_gecos = %s, and pw_name = %s\n",
           pw->pw_gecos, pw->pw_name);
#line 184
    printf((char const   */* __restrict  */)"nbuf before call to buildfname = %s\n",
           nbuf);
#line 186
    buildfname(pw->pw_gecos, pw->pw_name, nbuf);
#line 187
    printf((char const   */* __restrict  */)"nbuf after call to buildfname = %s\n",
           nbuf);
    }
#line 189
    if ((int )nbuf[0] != 0) {
      {
#line 190
      tmp___5 = strlen((char const   *)(nbuf)); 
#line 190
      tmp___6 = xalloc((int )(tmp___5 + 1UL));
#line 190
      a->q_fullname = strcpy((char */* __restrict  */)tmp___6, (char const   */* __restrict  */)(nbuf));
      }
    }
    {
#line 192
    printf((char const   */* __restrict  */)"test_buf should be GOOD.  test_buf = %s\n",
           test_buf);
    }
  }
#line 197
  a->q_flags |= 2147483648UL;
#line 198
  if ((unsigned long )buf != (unsigned long )(buf0)) {
    {
#line 199
    free((void *)buf);
    }
  }
#line 202
  return (a);
}
}
#line 230 "recipient-bad.c"
struct passwd *finduser(char *name , enum bool *fuzzyp ) 
{ 
  register struct passwd *pw ;
  register char *p ;
  enum bool tryagain ;
  int tmp ;
  unsigned short const   **tmp___0 ;
  char buf[5] ;
  char *tmp___1 ;
  int tmp___2 ;
  void *__cil_tmp11 ;

  {
  {
#line 239
  *fuzzyp = (enum bool )0;
#line 253
  pw = getpwnam((char const   *)name);
  }
#line 255
  if ((unsigned long )pw != (unsigned long )((void *)0)) {
#line 257
    return (pw);
  }
#line 261
  tryagain = (enum bool )0;
#line 262
  p = name;
  {
#line 262
  while (1) {
    while_continue: /* CIL Label */ ;
#line 262
    if (! ((int )*p != 0)) {
#line 262
      goto while_break;
    }
#line 264
    if (((int )*p & -128) == 0) {
      {
#line 264
      tmp___0 = __ctype_b_loc();
      }
#line 264
      if ((int const   )*(*tmp___0 + (int )*p) & 256) {
        {
#line 266
        tmp = tolower((int )*p);
#line 266
        *p = (char )tmp;
#line 267
        tryagain = (enum bool )1;
        }
      }
    }
#line 262
    p ++;
  }
  while_break: /* CIL Label */ ;
  }
  {
#line 270
  pw = getpwnam((char const   *)name);
  }
#line 273
  if (tryagain) {
#line 273
    if ((unsigned long )pw != (unsigned long )((void *)0)) {
#line 275
      *fuzzyp = (enum bool )1;
#line 276
      return (pw);
    }
  }
#line 281
  if (! MatchGecos) {
#line 283
    return ((struct passwd *)((void *)0));
  }
#line 287
  p = name;
  {
#line 287
  while (1) {
    while_continue___0: /* CIL Label */ ;
#line 287
    if (! ((int )*p != 0)) {
#line 287
      goto while_break___0;
    }
#line 289
    if ((int )*p == ((int )SpaceSub & 127)) {
#line 290
      *p = (char )' ';
    } else
#line 289
    if ((int )*p == 95) {
#line 290
      *p = (char )' ';
    }
#line 287
    p ++;
  }
  while_break___0: /* CIL Label */ ;
  }
  {
#line 292
  setpwent();
#line 293
  pw = getpwent();
#line 294
  }
  {
#line 295
  while (1) {
    while_continue___1: /* CIL Label */ ;
#line 295
    if (! ((unsigned long )pw != (unsigned long )((void *)0))) {
#line 295
      goto while_break___1;
    }
    { 
#line 308
    buildfname(pw->pw_gecos, pw->pw_name, buf);
#line 309
    tmp___1 = strchr((char const   *)(buf), ' ');
    }
#line 309
    if ((unsigned long )tmp___1 != (unsigned long )((void *)0)) {
      {
#line 309
      tmp___2 = strcasecmp((char const   *)(buf), (char const   *)name);
      }
#line 309
      if (! tmp___2) {
#line 311
        *fuzzyp = (enum bool )1;
#line 312
        return (pw);
      }
    }
    {
#line 315
    pw = getpwent();
    }
  }
  while_break___1: /* CIL Label */ ;
  }
#line 320
  return ((struct passwd *)((void *)0));
}
}
#line 71 "main-bad.c"
int main(void) 
{ 
  ADDRESS **sendq ;
  ADDRESS *ret_address ;
  int aliaslevel ;
  ADDRESS *a ;
  void *tmp ;
  ADDRESS *tmp___0 ;
  char *__cil_tmp7 ;
  char *__cil_tmp8 ;

  {
  {
#line 73
  sendq = (ADDRESS **)((void *)0);
#line 75
  aliaslevel = 0;
#line 78
  tmp = malloc(sizeof(struct address ));
#line 78
  a = (ADDRESS *)tmp;
#line 80
  a->q_flags = (u_long )0;
#line 82
  a->q_user = (char *)"rpc";
#line 84
  tmp___0 = recipient(a, sendq, aliaslevel);
#line 84
  ret_address = tmp___0;
#line 86
  printf((char const   */* __restrict  */)"Real name of user %s = %s\n", a->q_user,
         ret_address->q_fullname);
  }
#line 88
  return (0);
}
}
