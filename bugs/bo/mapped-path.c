/* Generated by CIL v. 1.7.3 */
/* print_CIL_Input is false */

#line 131 "/usr/include/x86_64-linux-gnu/bits/types.h"
typedef long __off_t;
#line 132 "/usr/include/x86_64-linux-gnu/bits/types.h"
typedef long __off64_t;
#line 212 "/usr/lib/gcc/x86_64-linux-gnu/4.6/include/stddef.h"
typedef unsigned long size_t;
#line 44 "/usr/include/stdio.h"
struct _IO_FILE;
#line 44
struct _IO_FILE;
#line 48 "/usr/include/stdio.h"
typedef struct _IO_FILE FILE;
#line 144 "/usr/include/libio.h"
struct _IO_FILE;
#line 154 "/usr/include/libio.h"
typedef void _IO_lock_t;
#line 160 "/usr/include/libio.h"
struct _IO_marker {
   struct _IO_marker *_next ;
   struct _IO_FILE *_sbuf ;
   int _pos ;
};
#line 245 "/usr/include/libio.h"
struct _IO_FILE {
   int _flags ;
   char *_IO_read_ptr ;
   char *_IO_read_end ;
   char *_IO_read_base ;
   char *_IO_write_base ;
   char *_IO_write_ptr ;
   char *_IO_write_end ;
   char *_IO_buf_base ;
   char *_IO_buf_end ;
   char *_IO_save_base ;
   char *_IO_backup_base ;
   char *_IO_save_end ;
   struct _IO_marker *_markers ;
   struct _IO_FILE *_chain ;
   int _fileno ;
   int _flags2 ;
   __off_t _old_offset ;
   unsigned short _cur_column ;
   signed char _vtable_offset ;
   char _shortbuf[1] ;
   _IO_lock_t *_lock ;
   __off64_t _offset ;
   void *__pad1 ;
   void *__pad2 ;
   void *__pad3 ;
   void *__pad4 ;
   size_t __pad5 ;
   int _mode ;
   char _unused2[(15UL * sizeof(int ) - 4UL * sizeof(void *)) - sizeof(size_t )] ;
};
#line 237 "/usr/include/stdio.h"
extern int fclose(FILE *__stream ) ;
#line 272
extern FILE *fopen(char const   * __restrict  __filename , char const   * __restrict  __modes ) ;
#line 362
extern int printf(char const   * __restrict  __format  , ...) ;
#line 622
extern char *fgets(char * __restrict  __s , int __n , FILE * __restrict  __stream ) ;
#line 129 "/usr/include/string.h"
extern  __attribute__((__nothrow__)) char *( __attribute__((__nonnull__(1,2), __leaf__)) strcpy)(char * __restrict  __dest ,
                                                                                                 char const   * __restrict  __src ) ;
#line 137
extern  __attribute__((__nothrow__)) char *( __attribute__((__nonnull__(1,2), __leaf__)) strcat)(char * __restrict  __dest ,
                                                                                                 char const   * __restrict  __src ) ;
#line 236
extern  __attribute__((__nothrow__)) char *( __attribute__((__nonnull__(1), __leaf__)) strchr)(char const   *__s ,
                                                                                               int __c )  __attribute__((__pure__)) ;
#line 263
extern  __attribute__((__nothrow__)) char *( __attribute__((__nonnull__(1), __leaf__)) strrchr)(char const   *__s ,
                                                                                                int __c )  __attribute__((__pure__)) ;
#line 399
extern  __attribute__((__nothrow__)) size_t ( __attribute__((__nonnull__(1), __leaf__)) strlen)(char const   *__s )  __attribute__((__pure__)) ;
#line 497 "/usr/include/unistd.h"
extern  __attribute__((__nothrow__)) int ( __attribute__((__nonnull__(1), __leaf__)) chdir)(char const   *__path ) ;
#line 69 "/usr/include/assert.h"
extern  __attribute__((__nothrow__, __noreturn__)) void ( __attribute__((__leaf__)) __assert_fail)(char const   *__assertion ,
                                                                                                   char const   *__file ,
                                                                                                   unsigned int __line ,
                                                                                                   char const   *__function ) ;
#line 93 "mapped-path-bad.c"
char mapped_path[10]  = {      (char )'/',      (char )'\000'};
#line 95 "mapped-path-bad.c"
char *mapping_getwd(char *path ) 
{ 
  size_t tmp ;
  char *__cil_tmp3 ;

  {
  {
#line 104
  tmp = strlen((char const   *)(mapped_path));
#line 104
  printf((char const   */* __restrict  */)"Copying %d chars into buffer path[] whose size = %d\n",
         tmp + 1UL, 11);
#line 107
  strcpy((char */* __restrict  */)path, (char const   */* __restrict  */)(mapped_path));
  }
#line 108
  return (path);
}
}
#line 112 "mapped-path-bad.c"
char pathspace[10]  ;
#line 113 "mapped-path-bad.c"
char old_mapped_path[10]  ;
#line 115 "mapped-path-bad.c"
void do_elem(char *dir ) 
{ 
  char *last ;
  char *__cil_tmp3 ;
  char *__cil_tmp4 ;

  {
#line 125
  if ((int )*(dir + 0) == 46) {
#line 125
    if ((int )*(dir + 1) == 0) {
#line 127
      return;
    }
  }
#line 131
  if ((int )*(dir + 0) == 46) {
#line 131
    if ((int )*(dir + 1) == 46) {
#line 131
      if ((int )*(dir + 2) == 0) {
        {
#line 134
        last = strrchr((char const   *)(mapped_path), '/');
        }
#line 134
        if (last) {
#line 136
          if ((unsigned long )last == (unsigned long )(mapped_path)) {
#line 137
            last ++;
          }
#line 138
          *last = (char )'\000';
        }
#line 140
        return;
      }
    }
  }
#line 144
  if ((int )mapped_path[0] == 47) {
#line 144
    if (! ((int )mapped_path[1] == 0)) {
      {
#line 146
      strcat((char */* __restrict  */)(mapped_path), (char const   */* __restrict  */)"/");
      }
    }
  } else {
    {
#line 146
    strcat((char */* __restrict  */)(mapped_path), (char const   */* __restrict  */)"/");
    }
  }
  {
#line 149
  strcat((char */* __restrict  */)(mapped_path), (char const   */* __restrict  */)dir);
  }
#line 150
  return;
}
}
#line 152 "mapped-path-bad.c"
int mapping_chdir(char *orig_path ) 
{ 
  int ret ;
  char *sl ;
  char *path ;
  size_t tmp ;
  size_t tmp___0 ;
  char *dir ;
  size_t tmp___1 ;
  char *__cil_tmp9 ;
  char *__cil_tmp10 ;
  char *__cil_tmp11 ;
  char *__cil_tmp12 ;
  char *__cil_tmp13 ;
  char *__cil_tmp14 ;
  char *__cil_tmp15 ;
  char *__cil_tmp16 ;
  char *__cil_tmp17 ;

  {
  {
#line 163
  printf((char const   */* __restrict  */)"Entering mapping_chdir with orig_path = %s\n",
         orig_path);
#line 165
  strcpy((char */* __restrict  */)(old_mapped_path), (char const   */* __restrict  */)(mapped_path));
#line 166
  path = pathspace;
#line 169
  strcpy((char */* __restrict  */)path, (char const   */* __restrict  */)orig_path);
#line 170
  tmp = strlen((char const   *)path);
#line 170
  printf((char const   */* __restrict  */)"Copying orig_path to path....max strlen(path) = %d. strlen(path) = %d\n",
         9, tmp);
#line 171
  tmp___0 = strlen((char const   *)path);
  }
#line 171
  if (tmp___0 >= 10UL) {
    {
#line 172
    printf((char const   */* __restrict  */)"ALERT:pathspace[MAXPATHLEN] has been overflowed!\n");
    }
  }
#line 176
  if ((int )*(path + 0) == 47) {
#line 177
    mapped_path[0] = (char )'/';
#line 178
    mapped_path[1] = (char )'\000';
#line 179
    path ++;
  }
  {
#line 182
  printf((char const   */* __restrict  */)"so far mapped_path = %s\n", mapped_path);
  }
  {
#line 184
  while (1) {
    while_continue: /* CIL Label */ ;
    {
#line 184
    sl = strchr((char const   *)path, '/');
    }
#line 184
    if (! sl) {
#line 184
      goto while_break;
    }
#line 186
    dir = path;
#line 187
    *sl = (char )'\000';
#line 188
    path = sl + 1;
#line 189
    if (*dir) {
      {
#line 190
      do_elem(dir);
      }
    }
#line 191
    if ((int )*path == 0) {
#line 192
      goto while_break;
    }
  }
  while_break: /* CIL Label */ ;
  }
#line 194
  if (*path) {
    {
#line 196
    printf((char const   */* __restrict  */)"path = %s.. calling do_elem\n", path);
#line 197
    do_elem(path);
    }
  }
  {
#line 199
  printf((char const   */* __restrict  */)"mapped_path = %s\n", mapped_path);
#line 200
  tmp___1 = strlen((char const   *)(mapped_path));
  }
#line 200
  if (tmp___1 >= 10UL) {
    {
#line 201
    printf((char const   */* __restrict  */)"ALERT: mapped_path[MAXPATHLEN] has been overflowed!\n");
    }
  }
  {
#line 205
  ret = chdir((char const   *)(mapped_path));
  }
#line 205
  if (ret < 0) {
    {
#line 206
    printf((char const   */* __restrict  */)"couldn\'t chdir to %s !\n", mapped_path);
#line 207
    strcpy((char */* __restrict  */)(mapped_path), (char const   */* __restrict  */)(old_mapped_path));
#line 208
    printf((char const   */* __restrict  */)"mapped_path changed to %s\n", mapped_path);
    }
  }
#line 211
  return (ret);
}
}
#line 226 "mapped-path-bad.c"
void pwd(void) 
{ 
  int canary ;
  char path[11] ;
  size_t tmp ;
  char *tmp___0 ;
  void *__cil_tmp5 ;
  char *__cil_tmp6 ;
  char *__cil_tmp7 ;
  char *__cil_tmp8 ;
  char *__cil_tmp9 ;
  char *__cil_tmp10 ;

  {
  {
#line 233
  canary = 7;
#line 249
  tmp___0 = mapping_getwd(path);
  }
#line 249
  if ((unsigned long )tmp___0 == (unsigned long )((char *)((void *)0))) {
    {
#line 254
    printf((char const   */* __restrict  */)"Couldn\'t get current directory!\n");
    }
  } else {
    {
#line 257
    printf((char const   */* __restrict  */)"Current directory = %s\n", path);
#line 258
    tmp = strlen((char const   *)(path));
#line 258
    printf((char const   */* __restrict  */)"max strlen(path) is %d, strlen(path) = %d\n",
           9, tmp);
#line 259
    printf((char const   */* __restrict  */)"Canary should be 7.  Canary = %d\n",
           canary);
    }
#line 260
    if (canary != 7) {
      {
#line 261
      printf((char const   */* __restrict  */)"ALERT: path[MAXPATHLEN + 1] has been overflowed!\n");
      }
    }
  }
#line 263
  return;
}
}
#line 266 "mapped-path-bad.c"
int main(int argc , char **argv ) 
{ 
  char orig_path[30] ;
  FILE *f ;
  void *__cil_tmp5 ;
  char *__cil_tmp6 ;
  char *__cil_tmp7 ;
  char *__cil_tmp8 ;
  char *__cil_tmp9 ;
  char *__cil_tmp10 ;
  char *__cil_tmp11 ;
  char *__cil_tmp12 ;
  char *__cil_tmp13 ;
  {
#line 271
  if (! (argc == 2)) {
    {
#line 271
    __assert_fail("argc == 2", "mapped-path-bad.c", 271U, "main");
    }
  }
  {
#line 272
  f = fopen((char const   */* __restrict  */)*(argv + 1), (char const   */* __restrict  */)"r");
  }
#line 273
  if (! ((unsigned long )f != (unsigned long )((void *)0))) {
    {
#line 273
    __assert_fail("f != ((void *)0)", "mapped-path-bad.c", 273U, "main");
    }
  }
  {
#line 275
  fgets((char */* __restrict  */)(orig_path), 30, (FILE */* __restrict  */)f);
#line 276
  fclose(f);
#line 278
  printf((char const   */* __restrict  */)"orig_path = %s\n", orig_path);
#line 280
  mapping_chdir(orig_path);
#line 281
  pwd();
  }
#line 285
  return (0);
}
}
